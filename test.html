<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Test Game</title>
    <style>
        canvas {
            border:1px solid #d3d3d3;
            /*background-color: #f1f1f1;*/
        }
        body {
            text-align: center;
        }
    </style>
</head>
<body>
<h4 id="score"></h4>
<script>
    ///////////////// Helper ////////////////
    function randomIntFromInterval(min,max)
    {
        return Math.floor(Math.random()*(max-min+1)+min);
    }

    /**
     * 50 FPS, 20ms refresh
     *
     * obstacles moving speed: 40px/s
     * player moving speed: 80px/s
     *
     * Width * Height px
     * Broad: 256 * 512
     * Player: 48 * 48
     * Bullet: 16 * 32
     * Enemy: 48 * 48
     * Each enemy x margin: 24
     * Each row enemy y margin: 48
     */
    var canvas = document.createElement("canvas");
    var ctx = canvas.getContext("2d");
    canvas.width = 256;
    canvas.height = 512;
    document.body.appendChild(canvas);


    // Game objects
    var player = {
        speed: 80, // movement in pixels per second
        x: 0,
        y: 0
    };
    var enemy = function(){
        this.x = 0;
        this.y = 0;
        this.xSpeed = 120;
        this.ySpeed = 240;
        this.row = 0;
        this.col = 0;
        this.rowTotal = 0;
        this.direction = 'right';
    };

    var bullet = function(){
        this.x = 0;
        this.y = 0;
        this.speed = 120;
    };

    var enemies = {
        data: [],
        maxX: 0,
        minX: 0,
        maxY: 0,
        minY: 0
    };

    var bullets = [];
    var score = 0;
    var rowEnemyRecord = [];

    //////////////////// Loading Images ////////////////////

    // Background image
    var bgReady = false;
    var bgImage = new Image();
    bgImage.onload = function () {
        bgReady = true;
    };
    bgImage.src = "assets/background.png";

    var playerReady = false;
    var playerImage = new Image();
    playerImage.onload = function () {
        playerReady = true;
    };

    playerImage.src = "assets/tank.png";

    var  enemyReady= false;
    var enemyImage = new Image();
    enemyImage.onload = function () {
        enemyReady = true;
    };
    enemyImage.src = "assets/brick.png";

    //////////////////// Loading Images ////////////////////

    // Handle keyboard controls
    var keysDown = {};

    addEventListener("keydown", function (e) {
        keysDown[e.keyCode] = true;
    }, false);

    addEventListener("keyup", function (e) {
        delete keysDown[e.keyCode];
    }, false);

    var reset = function () {
        // Throw the monster somewhere on the screen randomly
//        monster.x = 32 + (Math.random() * (canvas.width - 64));
//        monster.y = 32 + (Math.random() * (canvas.height - 64));

        player.x = (canvas.width - 48)/2;
        player.y = canvas.height - 48;

        // 3 rows of enemies, each row has random from 1 to 3
        for(var i = 0; i <= 2; i++){ //y
            var xSpeed = randomIntFromInterval(70, 150);
            for(var j = 0; j <= 2; j++){ //x
                var e = new enemy();
                e.x = j*(48 + 24);
                e.y = i*(48 + 48);
                e.row = i;
                e.col = j;
                e.rowTotal = 3;
                e.xSpeed = xSpeed;
                enemies.data.push(e);
            }
        }
    };

    // Update game objects
    var update = function (modifier) {
        if (38 in keysDown) { // Player holding up, firing bullet, firing every 2s
//            hero.y -= hero.speed * modifier;
        }
//        if (40 in keysDown) { // Player holding down
//            hero.y += hero.speed * modifier;
//        }
        if (37 in keysDown) { // Player holding left
            player.x -= player.speed * modifier;
        }
        if (39 in keysDown) { // Player holding right
            player.x += player.speed * modifier;
        }



        for(var i = 0; i<=enemies.data.length - 1; i++){
            var updateRow = false;
            var e = enemies.data[i];

            if(e.direction == 'left'){
                e.x -= e.xSpeed * modifier;
            } else {
                e.x += e.xSpeed * modifier;
            }

            /**
             * Only count on first enemy of each row
             */
            if(e.col !== 0){
                continue;
            }


            if(e.x <= 0 && e.direction == 'left'){
                e.direction = 'right';
                updateRow = true;
            }

            if((e.x + (e.rowTotal * 48) + (e.rowTotal - 1) * 24) >= canvas.width && e.direction == 'right'){
                e.direction = 'left';
                updateRow = true;
            }

            if(updateRow){
                for(var j = 0; j<=enemies.data.length - 1; j++){
                    var eRow = enemies.data[j];

                    if(eRow.row === e.row){
                        eRow.direction = e.direction;
                        eRow.y += eRow.ySpeed * modifier;
                    }
                }
            }
        }

//        for()

        // if bullet hit enemy, remove both
//        if (
//                hero.x <= (monster.x + 32)
//                && monster.x <= (hero.x + 32)
//                && hero.y <= (monster.y + 32)
//                && monster.y <= (hero.y + 32)
//        ) {
//            ++score;
//            reset();
//        }
    };

    // Draw everything
    var render = function () {
        if (bgReady) {
            ctx.drawImage(bgImage, 0, 0);
        }

        if (playerReady) {
            ctx.drawImage(playerImage, player.x, player.y);
        }

        if (enemyReady) {
            for(var i = 0; i<=enemies.data.length - 1; i++){
                ctx.drawImage(enemyImage, enemies.data[i].x, enemies.data[i].y);
            }
        }

        document.getElementById('score').innerHTML = "Score: " + score;
    };

    // The main game loop
    var main = function () {
        var now = Date.now();
        var delta = now - then;

        update(delta / 500);
        render();

        then = now;

        // Request to do animation frame
        requestAnimationFrame(main);
    };

    var w = window;
    requestAnimationFrame = w.requestAnimationFrame || w.webkitRequestAnimationFrame || w.msRequestAnimationFrame || w.mozRequestAnimationFrame;

    // Let's play this game!
    var then = Date.now();
    reset();
    main();
</script>
</body>
</html>